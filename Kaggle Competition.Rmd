---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


```{r}
setwd("C:/Users/victo/Downloads") 
#Don't forget to set your working directory before you start!

library("tidyverse")
library("tidymodels")
library("plotly")
library("skimr")
library(readr)

library(usethis)
usethis::edit_r_environ()
```



```{r}
dfTrain <- read_csv("C:/Users/victo/Downloads/airbnbTrain.csv/airbnbTrain.csv")

dfTest <- read_csv("C:/Users/victo/Downloads/airbnbTest.csv/airbnbTest.csv")
```


```{r}
str(dfTrain)
```

```{r}
dfTrain[c(3,5,17,20,32,34, 43, 45)]=NULL
```

```{r}
dfTrain$cleaning_fee = as.numeric(gsub("[\\$,]", "", dfTrain$cleaning_fee))
dfTrain$extra_people = as.numeric(gsub("[\\$,]", "", dfTrain$extra_people))
dfTrain$security_deposit = as.numeric(gsub("[\\$,]", "", dfTrain$security_deposit))
dfTrain$price = as.numeric(gsub("[\\$,]", "", dfTrain$price))
dfTrain$host_response_rate = as.numeric(gsub("[\\%,]", "", dfTrain$host_response_rate))

#library(stringr)
#str_split_fixed(dfTrain$host_verifications, ",", 10)


dfTest$cleaning_fee = as.numeric(gsub("[\\$,]", "", dfTest$cleaning_fee))
dfTest$extra_people = as.numeric(gsub("[\\$,]", "", dfTest$extra_people))
dfTest$security_deposit = as.numeric(gsub("[\\$,]", "", dfTest$security_deposit))
dfTest$price = as.numeric(gsub("[\\$,]", "", dfTest$price))
dfTest$host_response_rate = as.numeric(gsub("[\\%,]", "", dfTest$host_response_rate))

```

```{r}
dfTrain$is_business_travel_ready=NULL
dfTrain$host_acceptance_rate=NULL
dfTrain$host_has_profile_pic=NULL
dfTrain$weekly_price=NULL
dfTrain$monthly_price=NULL
dfTrain$square_feet=NULL
dfTrain$space=NULL
dfTrain$transit=NULL
dfTrain$host_since=NULL
dfTrain$latitude=NULL
dfTrain$longitude=NULL
dfTrain$host_verifications=NULL
dfTrain$state=NULL
dfTrain$city=NULL
dfTrain$host_location=NULL
dfTrain$host_neighbourhood=NULL
dfTrain$neighbourhood=NULL
dfTrain$market=NULL
dfTrain$zipcode=NULL
dfTrain$id=NULL
dfTrain$require_guest_phone_verification=NULL
dfTrain$require_guest_profile_picture=NULL
```

```{r}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}


dfTrain$security_deposit[is.na(dfTrain$security_deposit)]=
  Mode(dfTrain$security_deposit[!is.na(dfTrain$security_deposit)])

dfTrain$review_scores_value[is.na(dfTrain$review_scores_value)]=
  Mode(dfTrain$review_scores_value[!is.na(dfTrain$review_scores_value)])

dfTrain$review_scores_location[is.na(dfTrain$review_scores_location)]=
  Mode(dfTrain$review_scores_location[!is.na(dfTrain$review_scores_location)])


dfTrain$review_scores_checkin[is.na(dfTrain$review_scores_checkin)]=
  Mode(dfTrain$review_scores_checkin[!is.na(dfTrain$review_scores_checkin)])

dfTrain$review_scores_accuracy[is.na(dfTrain$review_scores_accuracy)]=
  Mode(dfTrain$review_scores_accuracy[!is.na(dfTrain$review_scores_accuracy)])

dfTrain$review_scores_communication[is.na(dfTrain$review_scores_communication)]=
  Mode(dfTrain$review_scores_communication[!is.na(dfTrain$review_scores_communication)])

dfTrain$review_scores_cleanliness[is.na(dfTrain$review_scores_cleanliness)]=
  Mode(dfTrain$review_scores_cleanliness[!is.na(dfTrain$review_scores_cleanliness)])

dfTrain$review_scores_rating[is.na(dfTrain$review_scores_rating)]=
  Mode(dfTrain$review_scores_rating[!is.na(dfTrain$review_scores_rating)])

dfTrain$host_response_rate[is.na(dfTrain$host_response_rate)]=
  Mode(dfTrain$host_response_rate[!is.na(dfTrain$host_response_rate)])

dfTrain$cleaning_fee[is.na(dfTrain$cleaning_fee)]=
  Mode(dfTrain$cleaning_fee[!is.na(dfTrain$cleaning_fee)])

dfTrain$bathrooms[is.na(dfTrain$bathrooms)]=
  Mode(dfTrain$bathrooms[!is.na(dfTrain$bathrooms)])

dfTrain$bedrooms[is.na(dfTrain$bedrooms)]=
  Mode(dfTrain$bedrooms[!is.na(dfTrain$bedrooms)])

dfTrain$beds[is.na(dfTrain$beds)]=
  Mode(dfTrain$beds[!is.na(dfTrain$beds)])

dfTrain$host_identity_verified[is.na(dfTrain$host_identity_verified)]=
  Mode(dfTrain$host_identity_verified[!is.na(dfTrain$host_identity_verified)])

dfTrain$host_is_superhost[is.na(dfTrain$host_is_superhost)]=
  Mode(dfTrain$host_is_superhost[!is.na(dfTrain$host_is_superhost)])

dfTrain$host_listings_count[is.na(dfTrain$host_listings_count)]=
  Mode(dfTrain$host_listings_count[!is.na(dfTrain$host_listings_count)])
################################################################
dfTest$security_deposit[is.na(dfTest$security_deposit)]=
  Mode(dfTest$security_deposit[!is.na(dfTest$security_deposit)])

dfTest$review_scores_value[is.na(dfTest$review_scores_value)]=
  Mode(dfTest$review_scores_value[!is.na(dfTest$review_scores_value)])

dfTest$review_scores_location[is.na(dfTest$review_scores_location)]=
  Mode(dfTest$review_scores_location[!is.na(dfTest$review_scores_location)])


dfTest$review_scores_checkin[is.na(dfTest$review_scores_checkin)]=
  Mode(dfTest$review_scores_checkin[!is.na(dfTest$review_scores_checkin)])

dfTest$review_scores_accuracy[is.na(dfTest$review_scores_accuracy)]=
  Mode(dfTest$review_scores_accuracy[!is.na(dfTest$review_scores_accuracy)])

dfTest$review_scores_communication[is.na(dfTest$review_scores_communication)]=
  Mode(dfTest$review_scores_communication[!is.na(dfTest$review_scores_communication)])

dfTest$review_scores_cleanliness[is.na(dfTest$review_scores_cleanliness)]=
  Mode(dfTest$review_scores_cleanliness[!is.na(dfTest$review_scores_cleanliness)])

dfTest$review_scores_rating[is.na(dfTest$review_scores_rating)]=
  Mode(dfTest$review_scores_rating[!is.na(dfTest$review_scores_rating)])

dfTest$host_response_rate[is.na(dfTest$host_response_rate)]=
  Mode(dfTest$host_response_rate[!is.na(dfTest$host_response_rate)])

dfTest$cleaning_fee[is.na(dfTest$cleaning_fee)]=
  Mode(dfTest$cleaning_fee[!is.na(dfTest$cleaning_fee)])

dfTest$bathrooms[is.na(dfTest$bathrooms)]=
  Mode(dfTest$bathrooms[!is.na(dfTest$bathrooms)])

dfTest$bedrooms[is.na(dfTest$bedrooms)]=
  Mode(dfTest$bedrooms[!is.na(dfTest$bedrooms)])

dfTest$beds[is.na(dfTest$beds)]=
  Mode(dfTest$beds[!is.na(dfTest$beds)])

dfTest$host_identity_verified[is.na(dfTest$host_identity_verified)]=
  Mode(dfTest$host_identity_verified[!is.na(dfTest$host_identity_verified)])

dfTest$host_is_superhost[is.na(dfTest$host_is_superhost)]=
  Mode(dfTest$host_is_superhost[!is.na(dfTest$host_is_superhost)])

dfTest$host_listings_count[is.na(dfTest$host_listings_count)]=
  Mode(dfTest$host_listings_count[!is.na(dfTest$host_listings_count)])


```

```{r}
a=dfTest[colnames(dfTest) %in% colnames(dfTrain)]
```

```{r}
dfTrain[is.na(dfTrain)] <- 'N/A'
a[is.na(a)] <- 'N/A'
a$property_type[a$property_type=='Minsu (Taiwan)']='Other'
dfTrain$high_booking_rate=factor(dfTrain$high_booking_rate)
```

```{r}

control <- trainControl(method="cv", number=10)
set.seed(123)
rf_gridsearch <- train(high_booking_rate~.-id, data=dfTrain, method="rf", metric='auc', tuneLength=10, trControl=control)


```

```{r}
library(caret)
fitLogCaret<- train(high_booking_rate ~ .-bed_type, family='binomial', data = dfTrain, method='glm')

resultsLogCaret<-fitLogCaret%>% 
  predict(dfTrain, type = 'raw') %>% 
  bind_cols(dfTrain, predictedClass=.)

resultsLogCaret %>% 
  xtabs(~predictedClass + high_booking_rate,.) %>% 
  confusionMatrix(positive = '1') 

library(cvAUC)
resultsLogCaret$predictedClass<-as.numeric(resultsLogCaret$predictedClass)
AUC(resultsLogCaret$predictedClass, resultsLogCaret$high_booking_rate)


test <-
fitLogCaret %>%
predict(a, type='prob') %>%
bind_cols(a, predictedClass=.)

b=dfTest%>%select(id)%>%cbind(test$`1`)
c=b%>%rename('high_booking_rate'='test$`1`')
write_csv(c,'predicted.csv')


```

```{r}
set.seed(123)
lambda <- 10^seq(-5, 2, length = 100)

fitElasticNet <- train(high_booking_rate~.,family='binomial', data = dfTrain, method = "glmnet",
trControl = trainControl("cv", number = 10),
tuneGrid = expand.grid(alpha = 0.5, lambda = lambda)
)
fitElasticNet$bestTune$lambda

resultsElasticNetCaret <-
fitElasticNet %>%
predict(dfTrain, type='raw') %>%
bind_cols(dfTrain, predictedClass=.)

resultsElasticNetCaret %>%
xtabs(~predictedClass+high_booking_rate, .) %>%
confusionMatrix(positive = '1')

library(cvAUC)
resultsElasticNetCaret$predictedClass<-as.numeric(resultsElasticNetCaret$predictedClass)
AUC(resultsElasticNetCaret$predictedClass, resultsElasticNetCaret$high_booking_rate)
```


```{r}
set.seed(123)
train.control <- trainControl(method = "cv", number = 10)
# Train the model
fitLDA <- train(high_booking_rate ~.,family='binomial', data = dfTrain, method = "lda",
trControl = train.control)
resultsLDACaret <-
fitLDA %>%
predict(dfTrain, type='raw') %>%
bind_cols(dfTrain, predictedClass=.)
resultsLDACaret %>%
xtabs(~predictedClass+high_booking_rate, .) %>%
confusionMatrix(positive = '1')

library(cvAUC)
resultsLDACaret$predictedClass<-as.numeric(resultsLDACaret$predictedClass)
AUC(resultsLDACaret$predictedClass, resultsLDACaret$high_booking_rate)
```

```{r}
lambda <- 10^seq(-5, 2, length = 100)
set.seed(123)
fitLasso <- train(
high_booking_rate ~.,family='binomial', data = dfTrain, method = "glmnet",
trControl = trainControl("cv", number = 10),
tuneGrid = expand.grid(alpha = 1, lambda = lambda)
)


resultsLasso <-
fitLasso %>%
predict(dfTrain, type='raw') %>%
bind_cols(dfTrain, predictedClass=.)
resultsLasso %>%
xtabs(~predictedClass+high_booking_rate, .) %>%
confusionMatrix(positive = '1')

library(cvAUC)

resultsLasso$predictedClass<-as.numeric(resultsLasso$predictedClass)
AUC(resultsLasso$predictedClass, resultsLasso$high_booking_rate)
```
```{r}
set.seed(123)
lambda <- 10^seq(-5, 2, length = 100)
set.seed(123)
fitRidge <- train(
high_booking_rate ~.,family='binomial', data = dfTrain, method = "glmnet",
trControl = trainControl("cv", number = 10),
tuneGrid = expand.grid(alpha = 0, lambda = lambda)
)
fitRidge$bestTune$lambda

resultsRidgeCaret <-
fitRidge %>%
predict(dfTrain, type='raw') %>%
bind_cols(dfTrain, predictedClass=.)

resultsRidgeCaret %>%
xtabs(~predictedClass+high_booking_rate, .) %>%
confusionMatrix(positive = '1')

library(cvAUC)

resultsRidgeCaret$predictedClass<-as.numeric(resultsRidgeCaret$predictedClass)
AUC(resultsRidgeCaret$predictedClass, resultsRidgeCaret$high_booking_rate)
```






